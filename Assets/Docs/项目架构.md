# 项目架构文档

## 1. 核心系统 (Core)

### 1.1 调试控制台系统 (DebugConsole)
- **DebugConsole.cs**
  - 功能: 提供游戏内调试命令界面
  - 主要命令:
    - help: 显示帮助信息
    - gridinfo: 显示网格信息
    - spawn: 生成随机元素
    - match: 手动触发匹配
    - rolldice: 掷骰子并生成元素
    - cleardice: 清空骰子
    - adddice: 添加测试骰子
    - listdice: 列出所有骰子信息
    - debug: 切换调试模式

### 1.2 网格管理系统 (GridManager)
- **GridManager.cs**
  - 功能: 管理游戏网格和元素
  - 主要职责:
    - 初始化网格数据
    - 生成网格可视化
    - 管理元素生成和放置
    - 处理骰子生成的元素
    - 提供网格操作接口

### 1.3 游戏控制器 (GameController)
- **GameController.cs**
  - 功能: 处理游戏主要逻辑
  - 主要职责:
    - 处理输入事件
    - 管理游戏状态
    - 控制调试模式
    - 处理元素匹配逻辑

## 2. 游戏系统 (GameSystems)

### 2.1 骰子系统 (DiceSystem)
- **DiceManager.cs**
  - 功能: 管理骰子相关逻辑
  - 主要职责:
    - 管理骰子集合
    - 处理骰子投掷
    - 生成元素
    - 提供骰子信息

### 2.2 元素系统
- **Element.cs**
  - 功能: 定义游戏中的元素
  - 属性:
    - 类型 (Type)
    - 等级 (Level)
    - 值 (Value)

这样设计的好处是：
元素和效果的关系配置化
支持一个元素多个效果
可以根据等级和数量自动升级
支持主动和被动效果
易于在编辑器中修改
方便添加新元素和效果
使用时，你需要：
在 GridManager 中引用 ElementConfig
2. 使用 ElementConfig 创建元素
3. 在匹配系统中使用配置判断升级条件
在效果系统中根据配置获取效果参数
这样就实现了元素和效果的联动，且易于扩展和维护。

### 2.3 匹配系统
- 功能: 处理元素匹配和消除
- 主要组件:
  - 匹配规则
  - 连锁反应
  - 元素交互

## 3. 工具类 (Utils)

### 3.1 数据结构 (Structs)
- **FilteredGroup**
  - 功能: 存储筛选后的组信息
  - 属性:
    - Group: 单元格列表
    - ElementType: 元素类型
    - Count: 数量
    - Sum: 总和

### 3.2 编辑器工具 (Editor)
- **ExcelToJsonWindow.cs**
  - 功能: Excel数据转换工具

## 4. 常量定义

### 4.1 网格常量 (GridConstants)
- 定义网格相关的常量值:
  - 行数 (Rows)
  - 列数 (Columns)
  - 其他网格相关常量

## 5. 事件系统

### 5.1 网格事件
- OnCellCreated: 单元格创建事件
- OnElementSpawned: 元素生成事件

## 6. 配置系统

### 6.1 骰子配置
- 功能: 管理骰子相关配置
- 配置项:
  - 骰子类型
  - 元素权重
  - 生成数量

## 7. 未来扩展计划

### 7.1 技能系统
- 计划功能:
  - 技能效果实现
  - 技能触发机制
  - 技能升级系统

### 7.2 遗物系统
- 计划功能:
  - 遗物效果
  - 遗物获取机制
  - 遗物升级

### 7.3 敌人系统
- 计划功能:
  - 敌人AI
  - 攻击机制
  - 状态效果

## 8. 代码规范

### 8.1 命名规范
- 类名: PascalCase
- 方法名: PascalCase
- 变量名: camelCase
- 私有字段: _camelCase

### 8.2 文件组织
- 按功能模块分类
- 核心系统放在Core文件夹
- 工具类放在Utils文件夹
- 编辑器扩展放在Editor文件夹

## 9. 依赖关系

### 9.1 核心依赖
- UnityEngine
- System.Collections.Generic
- TMPro (UI相关)

### 9.2 模块依赖
- GridManager -> DiceManager
- DebugConsole -> GridManager, GameController
- GameController -> GridManager

## 10. 性能考虑

### 10.1 优化重点
- 匹配算法效率
- 元素生成和销毁
- UI更新频率
- 内存管理

### 10.2 待优化项
- 日志系统的滚动实现
- 骰子配置的动态加载
- 网格更新机制 



## 特殊元素系统改进 (2024-12-14)

### 配置系统改进
1. 元素配置 (ElementConfig)
   - 新增主动特殊元素配置 (ActiveElementConfig)     ```csharp
     public class ActiveElementConfig
     {
         public int Range;            // 影响范围
         public int CoolDown;         // 冷却时间
         public int EnergyCost;       // 能量消耗
         public string TargetingType; // 目标选择类型
         public bool NeedTarget;      // 是否需要选择目标
     }     ```
   - 新增被动特殊元素配置 (PassiveElementConfig)     ```csharp
     public class PassiveElementConfig
     {
         public float TriggerChance;     // 触发概率
         public bool CanTriggerMultiple; // 是否可以多次触发
         public int MaxTriggersPerTurn;  // 每回合最大触发次数
     }     ```

2. 特殊元素配置整合
   - 统一配置入口 (SpecialElementConfig)
   - 支持主动/被动两种类型
   - 可在 Unity Inspector 中直观配置

### 效果系统改进
1. 效果管理器 (EffectManager)
   - 单例模式实现
   - 支持效果注册和队列执行
   - 提供调试接口

2. 火球效果示例 (FireballEffect)
   - 实现范围伤害
   - 元素相互作用（火元素增强，水元素削弱）
   - 支持自定义范围和伤害值

### 调试系统改进
1. 调试控制台 (DebugConsole)
   - 新增效果测试命令 (test_effect)
   - 支持通过命令创建测试场景
   - 示例：`test_effect:fireball` 创建火球测试布局

2. 可视化改进
   - 高亮显示效果范围
   - 显示元素状态变化

### 交互系统改进
1. 点击拖拽检测器 (ClickAndDragDetector)
   - 支持点击和拖拽事件
   - 提供拖拽阈值配置
   - 事件驱动的交互模式

### 配置示例
```yaml
Elements:
Type: Fire
SpecialConfig:
Type: Active
EffectID: effect_fireball
ActiveConfig:
Range: 2
CoolDown: 1
EnergyCost: 2
Type: Water
SpecialConfig:
Type: Passive
EffectID: effect_waterwave
PassiveConfig:
TriggerChance: 100
MaxTriggersPerTurn: 3
```


### 核心改动
1. 将特殊元素配置从硬编码迁移到可配置化
2. 增加了主动和被动两种特殊元素类型
3. 实现了完整的效果系统框架
4. 添加了调试工具支持

### 后续优化方向
1. 效果系统的扩展性优化
2. 更多特殊元素类型支持
3. 效果触发条件的多样化
4. 效果可视化的进一步改进
5. 配置工具的开发

